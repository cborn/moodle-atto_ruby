YUI.add("moodle-atto_ruby-button",function(e,t){var n={RUBYPREVIEW:"atto_ruby_preview",INPUTRUBY:"atto_ruby_phonetics",INPUTTEXT:"atto_ruby_text",INPUTREMOVE:"atto_ruby_remove",INPUTSUBMIT:"atto_ruby_submit"},r={INPUTURL:"."+n.INPUTRUBY},i="atto_ruby",s="<ruby><rb>{{text}}</rb><rp>{{placeholders.left}}</rp><rt>{{phonetic}}</rt><rp>{{placeholders.right}}</rp></ruby>",o='<form class="atto_form"><label for="{{elementid}}_{{CSS.INPUTTEXT}}">{{get_string "text" component}}</label><input class="fullwidth {{CSS.INPUTTEXT}}" type="text" id="{{elementid}}_{{CSS.INPUTTEXT}}" size="32"/><label for="{{elementid}}_{{CSS.INPUTRUBY}}">{{get_string "phonetics" component}}</label><input class="fullwidth {{CSS.INPUTRUBY}}" type="text" id="{{elementid}}_{{CSS.INPUTRUBY}}" size="32"/><br/><div class="mdl-align"><div class="{{CSS.RUBYPREVIEW}}">{{{renderedpreview}}}</div><button class="{{CSS.INPUTSUBMIT}}" type="submit">{{get_string "save" component}}</button><button class="{{CSS.INPUTREMOVE}}" type="submit">{{get_string "remove" component}}</button></div></form>';e.namespace("M.atto_ruby").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_selectedRuby:null,_wasPlainText:!1,_currentProperties:{text:"",phonetic:"",placeholders:{left:M.util.get_string("placeholderleft",i),right:M.util.get_string("placeholderright",i)}},_form:null,_rawImageDimensions:null,initializer:function(){this.addButton({icon:"icon",iconComponent:i,callback:this._displayDialogue,tags:"ruby",tagMatchRequiresAll:!1}),this.editor.delegate("dblclick",this._displayDialogue,"ruby",this),this.editor.delegate("click",this._handleClick,"ruby",this)},_handleClick:function(e){},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1)return;this._rawImageDimensions=null;var e=this.getDialogue({headerContent:M.util.get_string("addruby",i),width:"480px",focusAfterHide:!0,focusOnShowSelector:r.INPUTURL});e.set("bodyContent",this._getDialogueContent()).show()},_getDialogueContent:function(){var t=e.Handlebars.compile(o),r=e.Node.create(t({elementid:this.get("host").get("elementid"),CSS:n,component:i}));return console.log("elementid: "+this.get("host").get("elementid")),this._form=r,this._applyRubyProperties(this._form),this._form.one("."+n.INPUTRUBY).on("change",this._rubyChanged,this),this._form.one("."+n.INPUTTEXT).on("change",this._rubyChanged,this),this._form.one("."+n.INPUTRUBY).on("keyup",this._rubyChanged,this),this._form.one("."+n.INPUTTEXT).on("keyup",this._rubyChanged,this),this._form.one("."+n.INPUTSUBMIT).on("click",this._setRuby,this),this._form.one("."+n.INPUTREMOVE).on("click",this._clearRuby,this),r},_updatePreview:function(t){var r=e.Handlebars.compile(s),i=e.Node.create(r(t)),o=this._form.one("."+n.RUBYPREVIEW);window.foobar=i,o.set("innerHTML",""),i.appendTo(o)},_applyRubyProperties:function(e){var t=this._getSelectedRubyProperties();t.phonetic&&e.one("."+n.INPUTRUBY).set("value",t.phonetic),t.text&&e.one("."+n.INPUTTEXT).set("value",t.text),this._currentProperties=t,this._updatePreview(t)},_getSelectedRubyProperties:function(){var e={text:"",phonetic:"",placeholders:{left:M.util.get_string("placeholderleft",i),right:M.util.get_string("placeholderright",i)}},t=this.get("host"),n=this.get("host").getSelectedNodes();if(n&&n.size()){console.log(n),tag=n.item(0);if(tag.get("nodeName")!=="ruby"){var r=tag.ancestor("ruby");if(r===null)return e.text=this._currentSelection.toString(),e;tag=r,this._selectedRuby=tag}return tag.one("rb")!=null&&(e.text=tag.one("rb").get("text")),tag.one("rt")!=null&&(e.phonetic=tag.one("rt").get("text")),tag.all("rp").item(0)!=null&&(e.placeholders.left=tag.all("rp").item(0).get("text")),tag.all("rp").item(1)!=null&&(e.placeholders.right=tag.all("rp").item(1).get("text")),e}return!1},_rubyChanged:function(){var e=this._form.one("."+n.INPUTRUBY),t=this._form.one("."+n.INPUTTEXT),r=this._form.one("."+n.RUBYPREVIEW);this._currentProperties.phonetic=e.get("value"),this._currentProperties.text=t.get("value"),r.one("ruby")==null?this._updatePreview(this._currentProperties):(r.one("rb").set("text",this._currentProperties.text),r.one("rt").set("text",this._currentProperties.phonetic))},_setRuby:function(t){var r=this._form,i=this._form.one("."+n.INPUTRUBY),o=this._form.one("."+n.INPUTTEXT),u=this._form.one("."+n.RUBYPREVIEW),a=e.Handlebars.compile(s),f=a(this._currentProperties),l=this.get("host");i.get("value").trim().length===0?this._clearRuby(t):(t.preventDefault(),l.focus(),this._selectedRuby?l.setSelection(l.getSelectionFromNode(this._selectedRuby)):l.setSelection(this._currentSelection),this._currentSelection=null,this._selectedRuby=null,this.get("host").insertContentAtFocusPoint(f),this.markUpdated(),this.getDialogue({focusAfterHide:null}).hide())},_clearRuby:function(e){var t=this._form.one("."+n.INPUTTEXT),r=this.get("host");e.preventDefault(),r.focus(),this._selectedRuby?r.setSelection(r.getSelectionFromNode(this._selectedRuby)):r.setSelection(this._currentSelection),this.get("host").insertContentAtFocusPoint(t.get("value").trim()),this.markUpdated(),this.getDialogue({focusAfterHide:null}).hide()}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
